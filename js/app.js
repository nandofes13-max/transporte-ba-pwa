// js/app.js - Con bot√≥n visible en m√≥viles no-Chrome
class TransporteApp {
    constructor() {
        this.map = null;
        this.userMarker = null;
        this.userLocation = null;
        this.deferredPrompt = null;
        this.init();
    }

    async init() {
        console.log('üîç [INIT] App iniciada');
        console.log('üîç [INIT] Service Worker support:', 'serviceWorker' in navigator);
        console.log('üîç [INIT] App instalada:', this.isAppInstalled());
        console.log('üîç [INIT] Es desktop:', this.isDesktop());
        
        // Configurar eventos de instalaci√≥n PWA
        this.setupInstallPrompt();
        
        // Verificar Service Worker
        if ('serviceWorker' in navigator) {
            try {
                await navigator.serviceWorker.register('/sw.js');
                console.log('‚úÖ [SW] Service Worker registrado');
            } catch (error) {
                console.log('‚ùå [SW] Error registrando SW:', error);
            }
        }

        // Inicializar la aplicaci√≥n
        this.loadApp();
    }

    // FUNCI√ìN PARA DETECTAR SI ES DESKTOP
    isDesktop() {
        const userAgent = navigator.userAgent.toLowerCase();
        const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
        const isTablet = /(tablet|ipad|playbook|silk)|(android(?!.*mobile))/i.test(userAgent);
        
        console.log('üîç [DEVICE] Mobile:', isMobile, 'Tablet:', isTablet, 'Desktop:', !isMobile && !isTablet);
        return !isMobile && !isTablet;
    }

    // FUNCI√ìN PARA DETECTAR SI LA APP EST√Å INSTALADA
    isAppInstalled() {
        // M√©todo 1: Verificar display-mode (est√°ndar PWA)
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('üì± [DETECT] App detectada por display-mode: standalone');
            return true;
        }
        
        // M√©todo 2: iOS Safari
        if (window.navigator.standalone) {
            console.log('üì± [DETECT] App detectada por navigator.standalone');
            return true;
        }
        
        // M√©todo 3: Android Chrome
        if (document.referrer.includes('android-app://')) {
            console.log('üì± [DETECT] App detectada por referrer android');
            return true;
        }
        
        return false;
    }

    setupInstallPrompt() {
        console.log('üîç [SETUP] Configurando eventos de instalaci√≥n');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üéØ [PWA] Evento beforeinstallprompt DISPARADO');
            e.preventDefault();
            this.deferredPrompt = e;
            console.log('üîç [PWA] deferredPrompt guardado:', !!this.deferredPrompt);
        });

        window.addEventListener('appinstalled', (evt) => {
            console.log('üéâ [PWA] App instalada en el dispositivo');
            this.hideInstallButton();
        });
    }

    loadApp() {
        console.log('üîç [LOAD] Cargando aplicaci√≥n con mapa...');
        
        // EL BOT√ìN EST√Å OCULTO POR CSS - SOLO SE MUESTRA SI ES NECESARIO
        this.showInstallButtonIfNeeded();
        
        // Inicializar el mapa inmediatamente
        this.initMap();
        
        // Configurar event listeners
        this.setupEventListeners();
        
        console.log('üîç [LOAD] App cargada completamente');
    }

    // FUNCI√ìN PARA MOSTRAR BOT√ìN SOLO SI ES NECESARIO
    showInstallButtonIfNeeded() {
        const installBtn = document.getElementById('installBtn');
        if (!installBtn) return;
        
        // üÜï MOSTRAR EN M√ìVILES AUNQUE NO SEA CHROME
        const shouldShow = !this.isAppInstalled() && !this.isDesktop();
        
        console.log('üîç [SHOW-BTN] Mostrar bot√≥n?:', shouldShow, 
                   'Instalada:', this.isAppInstalled(), 
                   'Desktop:', this.isDesktop());
        
        if (shouldShow) {
            installBtn.classList.add('visible');
            console.log('‚úÖ [SHOW-BTN] Bot√≥n mostrado');
        } else {
            installBtn.classList.remove('visible');
            console.log('üö´ [SHOW-BTN] Bot√≥n ocultado');
        }
    }

    initMap() {
        console.log('üîç [MAP] Inicializando mapa...');
        this.map = L.map('map').setView([-34.6037, -58.3816], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(this.map);

        console.log('‚úÖ [MAP] Mapa inicializado');
    }

    setupEventListeners() {
        console.log('üîç [EVENTS] Configurando event listeners');
        
        document.getElementById('locateBtn').addEventListener('click', () => {
            console.log('üñ±Ô∏è [BTN] Bot√≥n ubicaci√≥n clickeado');
            this.centerOnUserLocation();
        });

        document.getElementById('installBtn').addEventListener('click', () => {
            console.log('üñ±Ô∏è [BTN] Bot√≥n instalar clickeado');
            this.installApp();
        });
        
        console.log('‚úÖ [EVENTS] Event listeners configurados');
    }

    async installApp() {
        console.log('üîç [INSTALL] Iniciando proceso de instalaci√≥n');
        console.log('üîç [INSTALL] deferredPrompt disponible:', !!this.deferredPrompt);
        
        if (this.deferredPrompt) {
            console.log('üöÄ [INSTALL] Intentando instalaci√≥n autom√°tica...');
            try {
                this.deferredPrompt.prompt();
                const { outcome } = await this.deferredPrompt.userChoice;
                console.log('üìã [INSTALL] Resultado instalaci√≥n:', outcome);
                
                if (outcome === 'accepted') {
                    console.log('‚úÖ [INSTALL] Usuario acept√≥ instalar la PWA');
                    this.hideInstallButton();
                    return;
                } else {
                    console.log('‚ùå [INSTALL] Usuario rechaz√≥ instalar la PWA');
                }
                
            } catch (error) {
                console.error('‚ùå [INSTALL] Error en instalaci√≥n autom√°tica:', error);
            }
            
            this.deferredPrompt = null;
            console.log('üîç [INSTALL] deferredPrompt limpiado');
        }
        
        // üÜï SI NO HAY DEFERREDPROMPT, MOSTRAR INSTRUCCIONES DE INSTALACI√ìN MANUAL
        console.log('üîç [INSTALL] Mostrando instrucciones de instalaci√≥n manual...');
        this.showInstallInstructions();
        console.log('üîç [INSTALL] Ocultando bot√≥n...');
        this.hideInstallButton();
    }

    // üÜï FUNCI√ìN PARA INSTRUCCIONES DE INSTALACI√ìN MANUAL
    showInstallInstructions() {
        alert('Para instalar la aplicaci√≥n:\n\n' +
              'En Chrome/Edge:\n' +
              '1. Men√∫ (‚ãÆ) ‚Üí "Agregar a pantalla de inicio"\n' +
              '2. Confirmar "Agregar"\n\n' +
              'En Safari:\n' + 
              '1. Bot√≥n compartir (üì§) ‚Üí "Agregar a inicio"\n' +
              '2. Click "Agregar"');
    }

    hideInstallButton() {
        console.log('üîç [HIDE] Intentando ocultar bot√≥n de instalaci√≥n');
        const installBtn = document.getElementById('installBtn');
        console.log('üîç [HIDE] Bot√≥n encontrado:', !!installBtn);
        
        if (installBtn) {
            installBtn.classList.remove('visible');
            console.log('‚úÖ [HIDE] Bot√≥n ocultado via CSS class');
        } else {
            console.log('‚ùå [HIDE] No se encontr√≥ el bot√≥n installBtn');
        }
    }

    async centerOnUserLocation() {
        console.log('üîç [LOCATION] Obteniendo ubicaci√≥n...');
        const locateBtn = document.getElementById('locateBtn');
        locateBtn.innerHTML = 'üìç Obteniendo ubicaci√≥n...';
        locateBtn.disabled = true;

        try {
            // PRIMERO: Intentar GPS de alta precisi√≥n
            const position = await this.getCurrentPosition();
            const { latitude, longitude, accuracy } = position.coords;
            
            console.log('üìç [LOCATION] GPS obtenido:', latitude, longitude, 'Precisi√≥n:', accuracy, 'm');
            
            // Si la precisi√≥n es mala (>1000m), usar fallback
            if (accuracy > 1000) {
                console.log('‚ö†Ô∏è [LOCATION] Precisi√≥n GPS pobre, usando fallback...');
                await this.useIPGeolocationFallback();
            } else {
                this.userLocation = { lat: latitude, lng: longitude };
                this.centerMapOnLocation(latitude, longitude);
                console.log('‚úÖ [LOCATION] Ubicaci√≥n GPS centrada');
            }
            
        } catch (error) {
            console.error('‚ùå [LOCATION] Error GPS:', error);
            
            // FALLBACK: Usar geolocalizaci√≥n por IP
            try {
                await this.useIPGeolocationFallback();
            } catch (ipError) {
                console.error('‚ùå [LOCATION] Error fallback IP:', ipError);
                this.handleLocationError(error);
            }
        } finally {
            locateBtn.innerHTML = 'üìç Centrar en mi ubicaci√≥n';
            locateBtn.disabled = false;
        }
    }

    // FUNCI√ìN DE FALLBACK POR IP
    async useIPGeolocationFallback() {
        console.log('üåê [LOCATION] Usando geolocalizaci√≥n por IP...');
        
        try {
            const response = await fetch('https://ipapi.co/json/');
            if (!response.ok) throw new Error('Error en API IP');
            
            const data = await response.json();
            console.log('üìç [LOCATION] IP geolocation:', data);
            
            if (data.latitude && data.longitude) {
                this.userLocation = { lat: data.latitude, lng: data.longitude };
                this.centerMapOnLocation(data.latitude, data.longitude);
                console.log('‚úÖ [LOCATION] Ubicaci√≥n por IP centrada');
            } else {
                throw new Error('No se pudo obtener ubicaci√≥n por IP');
            }
        } catch (error) {
            // √öLTIMO FALLBACK: Buenos Aires centro
            console.log('üèôÔ∏è [LOCATION] Usando ubicaci√≥n por defecto (Buenos Aires)');
            this.userLocation = { lat: -34.6037, lng: -58.3816 };
            this.centerMapOnLocation(-34.6037, -58.3816);
            console.log('‚úÖ [LOCATION] Ubicaci√≥n por defecto centrada');
        }
    }

    // FUNCI√ìN PARA CENTRAR MAPA (reutilizable)
    centerMapOnLocation(lat, lng) {
        this.map.setView([lat, lng], 15);
        
        if (this.userMarker) {
            this.userMarker.setLatLng([lat, lng]);
        } else {
            this.userMarker = L.marker([lat, lng])
                .addTo(this.map)
                .bindPopup('üìç Tu ubicaci√≥n actual')
                .openPopup();
        }
    }

    getCurrentPosition() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Geolocalizaci√≥n no soportada'));
                return;
            }

            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            });
        });
    }

    handleLocationError(error) {
        let message = 'Error desconocido al obtener la ubicaci√≥n';
        
        switch(error.code) {
            case error.PERMISSION_DENIED:
                message = 'Permiso de ubicaci√≥n denegado. Permite el acceso a la ubicaci√≥n para usar el mapa.';
                break;
            case error.POSITION_UNAVAILABLE:
                message = 'Informaci√≥n de ubicaci√≥n no disponible.';
                break;
            case error.TIMEOUT:
                message = 'Tiempo de espera agotado al obtener la ubicaci√≥n.';
                break;
        }

        alert(`‚ùå Error de ubicaci√≥n: ${message}`);
    }
}

// Inicializar la app cuando se cargue el DOM
document.addEventListener('DOMContentLoaded', () => {
    console.log('üìÑ [DOM] DOM completamente cargado');
    window.app = new TransporteApp();
});

console.log('üß© [SCRIPT] app.js cargado (antes de DOMContentLoaded)');
